<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RMì‹¬ì‚¬ ì‹œë®¬ë ˆì´í„° Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#2563eb;--blue-dk:#1d4ed8;--blue-lt:#eff6ff;
  --purple:#7c3aed;--green:#059669;--amber:#d97706;--red:#dc2626;
  --g50:#f8fafc;--g100:#f1f5f9;--g200:#e2e8f0;--g300:#cbd5e1;
  --g400:#94a3b8;--g500:#64748b;--g700:#334155;--g800:#1e293b;--g900:#0f172a;
  --r:10px;--rl:14px;--sh:0 2px 8px rgba(0,0,0,.08);--shl:0 8px 24px rgba(0,0,0,.12);
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans KR',sans-serif;background:#f0f4ff;min-height:100vh;color:var(--g800)}
.wrap{max-width:1100px;margin:0 auto;padding:20px}

.hdr{background:linear-gradient(135deg,#1e40af,#7c3aed);border-radius:var(--rl);padding:24px 30px;color:#fff;margin-bottom:20px}
.hdr-top{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.hdr h1{font-size:clamp(18px,2.8vw,24px);font-weight:800}
.chip{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);padding:3px 10px;border-radius:99px;font-size:11px;font-weight:700;letter-spacing:.04em;white-space:nowrap}
.chip.green{background:rgba(5,150,105,.3);border-color:rgba(5,150,105,.5)}
.hdr p{font-size:12px;opacity:.8;line-height:1.7}

.card{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:14px;overflow:hidden}
.ch{padding:14px 20px;border-bottom:1px solid var(--g100);display:flex;align-items:center;gap:8px;font-size:14px;font-weight:700;color:var(--g700)}
.cb{padding:18px 20px}

.tabs{display:grid;grid-template-columns:1fr 1fr;gap:3px;background:var(--g100);border-radius:var(--r);padding:3px;margin-bottom:14px}
.tab{padding:9px;border:none;background:transparent;border-radius:8px;font-size:13px;font-weight:600;color:var(--g500);cursor:pointer;font-family:inherit;transition:.18s}
.tab.on{background:#fff;color:var(--blue);box-shadow:var(--sh)}

.lbl{font-size:11px;font-weight:700;color:var(--g500);text-transform:uppercase;letter-spacing:.05em;margin-bottom:5px;display:block}
.row{display:flex;gap:8px;align-items:stretch}
.inp{flex:1;padding:10px 13px;border:2px solid var(--g200);border-radius:var(--r);font-size:14px;font-family:inherit;color:var(--g800);transition:.18s;min-width:0}
.inp:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.hint{margin-top:6px;font-size:11px;color:var(--g400);line-height:1.7}

.btn{padding:10px 18px;border:none;border-radius:var(--r);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:.18s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--purple));color:#fff;box-shadow:0 3px 10px rgba(37,99,235,.25)}
.btn-p:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 5px 14px rgba(37,99,235,.35)}
.btn-p:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-r{background:var(--red);color:#fff}

.prog{display:none;background:linear-gradient(135deg,#eff6ff,#f5f3ff);border:1px solid #bfdbfe;border-radius:var(--rl);padding:18px 22px;margin-bottom:14px}
.prog.on{display:block}
.prog-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.spin{width:20px;height:20px;border:3px solid rgba(37,99,235,.15);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.prog-ttl{font-size:13px;font-weight:700;color:var(--blue-dk)}
.steps{display:flex;flex-direction:column;gap:4px}
.stp{font-size:12px;color:var(--g400);display:flex;align-items:center;gap:7px;line-height:1.4}
.stp.done{color:var(--green)}.stp.cur{color:var(--blue);font-weight:600}
.dot{width:6px;height:6px;border-radius:50%;background:var(--g300)}
.stp.done .dot{background:var(--green)}.stp.cur .dot{background:var(--blue);animation:pls 1s infinite}
@keyframes pls{0%,100%{transform:scale(1)}50%{transform:scale(1.6);opacity:.4}}

.logbox{background:#0f172a;border-radius:8px;padding:10px 13px;margin-top:10px;max-height:180px;overflow-y:auto;font-family:'Courier New',monospace;font-size:11px;color:#86efac;line-height:1.6}
.ll{margin-bottom:1px}.ll.e{color:#fca5a5}.ll.w{color:#fde68a}.ll.i{color:#93c5fd}

.biz{display:none;background:#fff;border-radius:var(--rl);box-shadow:var(--shl);margin-bottom:14px;overflow:hidden}
.biz.on{display:block}
.biz-top{background:linear-gradient(135deg,#1e40af,#7c3aed);padding:18px 22px;color:#fff;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:8px}
.biz-name{font-size:18px;font-weight:800}
.biz-sub{font-size:12px;opacity:.75;margin-top:3px}
.vbadge{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.3);padding:3px 10px;border-radius:99px;font-size:11px;font-weight:700}
.bgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr))}
.bc{padding:11px 16px;border-right:1px solid var(--g100);border-bottom:1px solid var(--g100)}
.bc-l{font-size:10px;font-weight:700;color:var(--g400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
.bc-v{font-size:13px;font-weight:600;color:var(--g800);word-break:break-all;line-height:1.4}
.bc-v.ok{color:var(--green)}.bc-v.bad{color:var(--red)}.bc-v.warn{color:var(--amber)}.bc-v.gray{color:var(--g400)}
.bc-v.hi{color:var(--blue);font-weight:700}
.abar{display:flex;flex-wrap:wrap;gap:6px;padding:11px 16px;background:var(--g50);border-top:1px solid var(--g100)}
.src-chip{font-size:11px;font-weight:600;padding:3px 10px;border-radius:99px;border:1px solid}
.src-chip.ok{background:#f0fdf4;border-color:#86efac;color:var(--green)}
.src-chip.fail{background:#fff5f5;border-color:#fca5a5;color:var(--red)}
.src-chip.skip{background:var(--g50);border-color:var(--g300);color:var(--g500)}

/* ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„ */
.site-anal{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:14px;overflow:hidden}
.site-top{background:linear-gradient(135deg,#f0fdf4,#ecfdf5);border-bottom:1px solid #86efac;padding:14px 20px}
.site-top h3{font-size:14px;font-weight:700;color:var(--green);display:flex;align-items:center;gap:6px}
.site-body{padding:18px 20px}
.site-desc{font-size:13px;color:var(--g700);line-height:1.8;margin-bottom:16px;padding:12px;background:var(--g50);border-radius:var(--r);border-left:3px solid var(--green)}
.site-meta{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:14px}
.sm-item{background:var(--g50);border:1px solid var(--g200);border-radius:var(--r);padding:10px 14px}
.sm-lbl{font-size:10px;font-weight:700;color:var(--g400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px}
.sm-val{font-size:14px;font-weight:700;color:var(--g800)}

/* ìƒí’ˆ ë¶„ì„ */
.prod-sec{margin-top:16px}
.prod-sec h4{font-size:13px;font-weight:700;color:var(--g700);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--g100)}
.prod-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:8px}
.prod-item{background:#fff;border:1px solid var(--g200);border-radius:var(--r);padding:10px;transition:.2s}
.prod-item:hover{border-color:var(--blue);box-shadow:var(--sh)}
.prod-name{font-size:12px;font-weight:600;color:var(--g700);margin-bottom:4px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.prod-price{font-size:15px;font-weight:700;color:var(--blue)}
.prod-cat{font-size:11px;color:var(--g400);margin-top:3px}

.alert{display:none;background:#fffbeb;border:1px solid #fde68a;border-radius:var(--r);padding:13px 17px;margin-bottom:14px}
.alert.on{display:block}
.al-t{font-size:13px;font-weight:700;color:var(--amber);margin-bottom:7px}
.alert ul{list-style:none;display:flex;flex-direction:column;gap:4px}
.alert li{font-size:12px;color:#374151;padding:6px 10px;background:#fff;border-radius:7px;line-height:1.5}

.cat{background:#fff;border-radius:var(--rl);box-shadow:var(--sh);margin-bottom:10px;overflow:hidden}
.cat.unv{border:2px solid #fca5a5}
.cat-hd{padding:10px 16px;background:var(--g50);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--g100);flex-wrap:wrap;gap:5px}
.cat-ttl{font-size:13px;font-weight:700;color:var(--g700);display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.wb{background:var(--blue);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:99px}
.ut{background:#fee2e2;color:var(--red);font-size:10px;font-weight:600;padding:2px 6px;border-radius:99px}
.rg{display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:6px;padding:12px 16px}
.rb{padding:8px 11px;border:2px solid var(--g200);border-radius:8px;background:#fff;cursor:pointer;display:flex;justify-content:space-between;align-items:center;gap:7px;font-family:inherit;transition:.13s;text-align:left}
.rb:hover{border-color:var(--blue);background:var(--blue-lt)}
.rb.sel{border-color:var(--blue);background:var(--blue-lt)}
.rb.autosel{border-color:#fca5a5;background:#fff5f5}
.rb-n{font-size:12px;color:var(--g700);font-weight:500;line-height:1.3}
.rb-s{font-size:12px;font-weight:700;color:var(--blue);flex-shrink:0}
.rb.autosel .rb-s{color:var(--red)}

.result{background:var(--g900);border-radius:var(--rl);padding:24px;color:#fff;margin-top:8px}
.result h2{font-size:16px;font-weight:800;text-align:center;margin-bottom:18px;color:#fff}
.score-box{text-align:center;padding:22px;background:linear-gradient(135deg,rgba(37,99,235,.18),rgba(124,58,237,.18));border:1px solid rgba(99,102,241,.28);border-radius:var(--rl);margin-bottom:16px}
.sc-lbl{font-size:11px;color:var(--g400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:5px}
.sc-num{font-size:52px;font-weight:800;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-.04em;line-height:1}
.rg2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.ri{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);padding:13px 15px}
.ri.hi{background:linear-gradient(135deg,rgba(37,99,235,.18),rgba(124,58,237,.18));border-color:rgba(99,102,241,.35)}
.ri-l{font-size:10px;color:var(--g400);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px}
.ri-v{font-size:17px;font-weight:700;color:#fff}
.ri.hi .ri-v{background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.gsec{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--rl);padding:18px;margin-bottom:14px;text-align:center}
.g-lbl{font-size:10px;color:var(--g400);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px}
.gb{display:inline-block;padding:9px 30px;border-radius:var(--r);font-size:32px;font-weight:800;margin-bottom:8px}
.g1{background:linear-gradient(135deg,#059669,#047857);color:#fff}
.g2{background:linear-gradient(135deg,#2563eb,#1d4ed8);color:#fff}
.g3{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff}
.g4{background:linear-gradient(135deg,#d97706,#b45309);color:#fff}
.g5{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff}
.g6{background:linear-gradient(135deg,#7f1d1d,#450a0a);color:#fff}
.gc{background:linear-gradient(135deg,#991b1b,#7f1d1d);color:#fff}
.g-mon{font-size:13px;color:var(--g300)}
.gmeta{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}
.gmi{background:rgba(255,255,255,.05);border-radius:8px;padding:9px}
.gmi-l{font-size:10px;color:var(--g500);margin-bottom:2px}
.gmi-v{font-size:13px;font-weight:700;color:#fff}
.rev{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);padding:13px;margin-bottom:8px}
.rev-t{font-size:11px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px}
.rev-b{font-size:12px;color:var(--g300);line-height:1.8}
.ctbl{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:var(--r);overflow:hidden;margin-top:14px}
.ctbl-t{padding:10px 13px;font-size:11px;font-weight:700;color:var(--g300);border-bottom:1px solid rgba(255,255,255,.08)}
.ctbl table{width:100%;border-collapse:collapse}
.ctbl th{padding:8px 12px;font-size:10px;font-weight:600;color:var(--g400);text-transform:uppercase;background:rgba(255,255,255,.03);border-bottom:1px solid rgba(255,255,255,.08);text-align:center}
.ctbl td{padding:8px 12px;font-size:12px;color:var(--g300);border-bottom:1px solid rgba(255,255,255,.05);text-align:center}
.ctbl tr.cur td{background:rgba(37,99,235,.15);color:#60a5fa;font-weight:700}

.ov{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9000;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
.ov.on{display:flex}
.pop{background:#fff;border-radius:var(--rl);padding:24px 36px;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.2);min-width:220px}
.pop-ic{font-size:32px;margin-bottom:8px}
.pop-msg{font-size:14px;font-weight:700;color:var(--g800);white-space:pre-line}

@media(max-width:640px){
  .rg2,.gmeta{grid-template-columns:1fr}
  .bgrid,.site-meta{grid-template-columns:1fr}
  .rg,.prod-list{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="wrap">

<div class="hdr">
  <div class="hdr-top">
    <h1>ğŸ“Š RMì‹¬ì‚¬ ì‹œë®¬ë ˆì´í„° Pro</h1>
    <span class="chip green">ğŸ¤– Gemini API</span>
    <span class="chip">ğŸ’° ì •í™•ë„ í–¥ìƒ</span>
  </div>
  <p>
    <b>ğŸ¤– Gemini AI í†µí•©</b> (ì‚¬ì—…ì í™ˆí˜ì´ì§€ ìë™ ê²€ìƒ‰ + ì‚¬ì´íŠ¸ íŠ¹ì„± AI ë¶„ì„) â†’
    <b>Footer ì§‘ì¤‘ íŒŒì‹±</b> (ì‚¬ì—…ìì •ë³´ ì¶”ì¶œ ì •í™•ë„ â†‘) â†’
    <b>ìƒí’ˆ ë¶„ì„ ê°•í™”</b> (ê°œë³„ ìƒí’ˆëª…/ê°€ê²©/ì¹´í…Œê³ ë¦¬)
  </p>
</div>

<div class="card">
  <div class="ch">ğŸ” ë¶„ì„ ì…ë ¥</div>
  <div class="cb">
    <div class="tabs">
      <button class="tab on" id="tAuto" onclick="setMode('auto')">ğŸ¤– ìë™ ë¶„ì„</button>
      <button class="tab"    id="tManu" onclick="setMode('manual')">âœï¸ ìˆ˜ë™ ì…ë ¥</button>
    </div>

    <div id="autoArea">
      <div class="tabs" style="margin-bottom:12px">
        <button class="tab on" id="tUrl" onclick="setAType('url')">ğŸŒ ì›¹ì‚¬ì´íŠ¸ URL</button>
        <button class="tab"    id="tBiz" onclick="setAType('biz')">ğŸ¢ ì‚¬ì—…ìë²ˆí˜¸</button>
      </div>

      <div id="aUrl">
        <div class="lbl">ê¸°ì—… ì›¹ì‚¬ì´íŠ¸ URL</div>
        <div class="row">
          <input class="inp" id="urlInp" placeholder="example.co.kr ë˜ëŠ” https://example.co.kr"
                 onkeydown="if(event.key==='Enter')doUrl()">
          <button class="btn btn-p" id="btnUrl" onclick="doUrl()">ğŸš€ ë¶„ì„</button>
        </div>
        <div class="hint">
          <b>Footer ìš°ì„  íŒŒì‹±:</b> í•˜ë‹¨ íšŒì‚¬ì •ë³´ ì˜ì—­ì—ì„œ ì‚¬ì—…ìë²ˆí˜¸Â·ìƒí˜¸Â·ëŒ€í‘œì ì¶”ì¶œ ì •í™•ë„ í–¥ìƒ<br>
          <b>ìƒí’ˆ ë¶„ì„:</b> ê°œë³„ ìƒí’ˆëª…Â·ê°€ê²©Â·ì¹´í…Œê³ ë¦¬ ìˆ˜ì§‘ â†’ ê°ë‹¨ê°€ ë¶„í¬ ê³„ì‚°<br>
          <b>ì‚¬ì´íŠ¸ íŠ¹ì„±:</b> ì–´ë–¤ ì¢…ë¥˜ì˜ ìƒí’ˆì„ íŒŒëŠ”ì§€ ìë™ ë¶„ë¥˜ ë° ì„¤ëª… ìƒì„±
        </div>
      </div>

      <div id="aBiz" style="display:none">
        <div class="lbl">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div>
        <div class="row">
          <input class="inp" id="bizInp" placeholder="123-45-67890" maxlength="12"
                 oninput="fmtBiz(this)" onkeydown="if(event.key==='Enter')doBiz()">
          <button class="btn btn-p" id="btnBiz" onclick="doBiz()">ğŸš€ ë¶„ì„</button>
        </div>
        <div class="hint">
          êµ­ì„¸ì²­Â·ê³µì •ìœ„Â·DART ê³µê³µAPI +
          <b>ğŸ¤– Gemini AIë¡œ í™ˆí˜ì´ì§€ ìë™ ë°œê²¬ & ì‚¬ì´íŠ¸ íŠ¹ì„± AI ë¶„ì„</b>
        </div>
      </div>
    </div>

    <div style="margin-top:14px">
      <div class="lbl">ğŸ’° ìŠ¹ì¸í•œë„</div>
      <input class="inp" id="limitInp" value="10,000,000" oninput="fmtLimit(this);calc()">
    </div>
  </div>
</div>

<div class="prog" id="prog">
  <div class="prog-head">
    <div class="spin"></div>
    <div class="prog-ttl" id="progTtl">ì¤€ë¹„ ì¤‘...</div>
  </div>
  <div class="steps" id="steps"></div>
  <div class="logbox" id="logbox"></div>
</div>

<div class="biz" id="bizCard">
  <div class="biz-top">
    <div>
      <div class="biz-name" id="dispName">-</div>
      <div class="biz-sub"  id="dispSub">-</div>
    </div>
    <div class="vbadge" id="vBadge" style="display:none">âœ“ ì‚¬ì—…ì í™•ì¸ë¨</div>
  </div>
  <div class="bgrid" id="bgrid"></div>
  <div class="abar"  id="abar"></div>
</div>

<!-- ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„ -->
<div class="site-anal" id="siteAnal" style="display:none">
  <div class="site-top">
    <h3>ğŸª ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„</h3>
  </div>
  <div class="site-body">
    <div class="site-desc" id="siteDesc">ë¶„ì„ ì¤‘...</div>
    <div class="site-meta" id="siteMeta"></div>
    <div class="prod-sec">
      <h4>ğŸ“¦ ë°œê²¬ëœ ìƒí’ˆ ëª©ë¡</h4>
      <div class="prod-list" id="prodList"></div>
    </div>
  </div>
</div>

<div class="alert" id="alertBox">
  <div class="al-t">âš ï¸ ì§ì ‘ í™•ì¸ì´ í•„ìš”í•œ í•­ëª©</div>
  <ul id="alertList"></ul>
</div>

<div id="catArea"></div>

<div class="result">
  <h2>ğŸ“Š ì‹¬ì‚¬ ê²°ê³¼</h2>
  <div class="score-box">
    <div class="sc-lbl">ì´ ì ìˆ˜</div>
    <div class="sc-num" id="totalScore">0<span style="font-size:18px">ì </span></div>
  </div>
  <div class="rg2">
    <div class="ri">   <div class="ri-l">ìŠ¹ì¸í•œë„</div>    <div class="ri-v" id="rLimit">-</div></div>
    <div class="ri hi"><div class="ri-l">ë‹´ë³´ ì„¤ì •ì•¡</div><div class="ri-v" id="rColl">-</div></div>
  </div>
  <div class="gsec">
    <div class="g-lbl">ğŸ† RM ë“±ê¸‰</div>
    <div class="gb gc" id="gBadge">-</div>
    <div class="g-mon" id="gMon">ë“±ê¸‰ ë¯¸ì‚°ì •</div>
    <div class="gmeta">
      <div class="gmi"><div class="gmi-l">ê¸°ì¤€ ì ìˆ˜</div>    <div class="gmi-v" id="baseScore">0</div></div>
      <div class="gmi"><div class="gmi-l">ëª¨ë‹ˆí„°ë§ ìˆ˜ì¤€</div><div class="gmi-v" id="monLv">-</div></div>
      <div class="gmi"><div class="gmi-l">ëª¨ë‹ˆí„°ë§ ì£¼ê¸°</div><div class="gmi-v" id="monFr">-</div></div>
    </div>
  </div>
  <div id="revArea"></div>
  <div class="ctbl">
    <div class="ctbl-t">ğŸ“Š ë‹´ë³´ ì‚°ì • ê¸°ì¤€í‘œ</div>
    <table><thead><tr><th>ì ìˆ˜ êµ¬ê°„</th><th>ë‹´ë³´ ë¹„ìœ¨</th></tr></thead>
    <tbody id="collTb"></tbody></table>
  </div>
  <div style="text-align:center;margin-top:18px">
    <button class="btn btn-r" onclick="resetAll()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
  </div>
</div>

</div>

<div class="ov" id="ov">
  <div class="pop">
    <div class="pop-ic"  id="popIc">âœ…</div>
    <div class="pop-msg" id="popMsg">ì™„ë£Œ</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEMINI_API_KEY = 'AIzaSyCulJB8Sd4XPDDAosfMdTLTqTDZ93s6FC8';
const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';

const CATS = [
  { id:0, name:'ìë³¸ê¸ˆ',      w:1, ranges:[{l:'1ì–µ ë¯¸ë§Œ',s:0},{l:'1ì–µ~10ì–µ',s:2},{l:'10ì–µ~100ì–µ',s:3},{l:'100ì–µ~1000ì–µ',s:4},{l:'1000ì–µ ì´ìƒ',s:5}] },
  { id:1, name:'ë§¤ì¶œì•¡',      w:2, ranges:[{l:'1ì–µ ë¯¸ë§Œ',s:0},{l:'1ì–µ~10ì–µ',s:2},{l:'10ì–µ~100ì–µ',s:3},{l:'100ì–µ~1000ì–µ',s:4},{l:'1000ì–µ ì´ìƒ',s:5}] },
  { id:2, name:'ê¸°ì—…ë“±ê¸‰',    w:2, ranges:[{l:'dë“±ê¸‰',s:-30},{l:'cë“±ê¸‰',s:0},{l:'bë“±ê¸‰',s:3},{l:'aë“±ê¸‰ ì´ìƒ',s:5}] },
  { id:3, name:'ëŒ€í‘œì êµ­ì ', w:1, ranges:[{l:'ê³ ìœ„í—˜ êµ­ê°€',s:-100},{l:'ì¤‘ìœ„í—˜ êµ­ê°€',s:0},{l:'ì €ìœ„í—˜ (í•œêµ­ ë“±)',s:3}] },
  { id:4, name:'ëŒ€í‘œì ë‚˜ì´', w:1, ranges:[{l:'30ì„¸ ë¯¸ë§Œ',s:0},{l:'30~40ì„¸',s:1},{l:'40~50ì„¸',s:2},{l:'50ì„¸ ì´ìƒ',s:3}] },
  { id:5, name:'ì‚¬ì—…ë…„ìˆ˜',    w:1, ranges:[{l:'1ë…„ ë¯¸ë§Œ',s:0},{l:'1~5ë…„',s:1},{l:'5~10ë…„',s:2},{l:'10ë…„ ì´ìƒ',s:3}] },
  { id:6, name:'ë°°ì†¡ì£¼ê¸°',    w:5, ranges:[{l:'3ì¼ ë¯¸ë§Œ',s:0},{l:'3~7ì¼',s:3},{l:'7~15ì¼',s:5},{l:'15~30ì¼',s:-10},{l:'30ì¼ ì´ìƒ',s:-30}] },
  { id:7, name:'ê°ë‹¨ê°€',      w:3, ranges:[{l:'5ë§Œì› ë¯¸ë§Œ',s:0},{l:'5~10ë§Œì›',s:1},{l:'10~30ë§Œì›',s:2},{l:'30~50ë§Œì›',s:3},{l:'50ë§Œì› ì´ìƒ',s:-10}] },
  { id:8, name:'ìƒí’ˆ ìœ í˜•',   w:5, ranges:[{l:'ì‹¤ë¬¼ìƒí’ˆ (ì¼ë°˜)',s:0},{l:'ì˜ˆì•½ìƒí’ˆ (í•­ê³µÂ·ìˆ™ë°•)',s:-5},{l:'ë¹„ì‹¤ë¬¼ìƒí’ˆ (ë””ì§€í„¸)',s:-3}] }
];

const COLL_TBL = [
  {min:-9999,r:1.0},{min:0,r:0.6},{min:30,r:0.5},
  {min:50,r:0.4},{min:70,r:0.3},{min:90,r:0.1},{min:100,r:0.0}
];
const GRADE_TBL = [
  {min:-9999,g:'í˜‘ì˜ í•„ìš”'},{min:-10,g:'5 or 6ë“±ê¸‰'},{min:15,g:'4 or 5ë“±ê¸‰'},
  {min:20,g:'3ë“±ê¸‰'},{min:25,g:'2ë“±ê¸‰'},{min:30,g:'1ë“±ê¸‰'}
];
const MON_TBL = {
  1:{lv:'ììœ¨',fr:'ë¶„ê¸°Â·ì›”'},2:{lv:'ì¼ìƒ',fr:'ì›”Â·ì£¼'},
  3:{lv:'ìˆ˜ì‹œ',fr:'ì£¼Â·ì¼'}, 4:{lv:'ìƒì‹œ',fr:'ë§¤ì¼'},
  5:{lv:'ìƒì‹œ',fr:'ë§¤ì¼'}, 6:{lv:'ìƒì‹œ',fr:'ë§¤ì¼'}
};

const PROXIES = [
  u => `https://api.allorigins.win/get?url=${encodeURIComponent(u)}`,
  u => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u => `https://corsproxy.io/?${encodeURIComponent(u)}`
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sel={}, unv=[], mode='auto', atype='url', lastInfo=null, apiSt={};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì´ˆê¸°í™”
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){ renderCats(); renderColl(); }

function setMode(m){
  mode=m;
  ['Auto','Manu'].forEach(x=>document.getElementById('t'+x).classList.toggle('on',x.toLowerCase().startsWith(m.slice(0,4))));
  document.getElementById('autoArea').style.display = m==='auto'?'block':'none';
}
function setAType(t){
  atype=t;
  document.getElementById('tUrl').classList.toggle('on',t==='url');
  document.getElementById('tBiz').classList.toggle('on',t==='biz');
  document.getElementById('aUrl').style.display = t==='url'?'block':'none';
  document.getElementById('aBiz').style.display = t==='biz'?'block':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmtBiz   = el => { let v=el.value.replace(/\D/g,'').slice(0,10); if(v.length>5)v=v.slice(0,3)+'-'+v.slice(3,5)+'-'+v.slice(5); else if(v.length>3)v=v.slice(0,3)+'-'+v.slice(3); el.value=v; };
const fmtLimit = el => { const v=el.value.replace(/\D/g,''); el.value=v?Number(v).toLocaleString():''; };
const getLimit = ()  => parseInt(document.getElementById('limitInp').value.replace(/,/g,''))||0;
const sleep    = ms  => new Promise(r=>setTimeout(r,ms));
const bizFmt   = v   => { const n=String(v).replace(/\D/g,''); return n.length===10?n.slice(0,3)+'-'+n.slice(3,5)+'-'+n.slice(5):v; };
const moneyFmt = n   => Number(n).toLocaleString()+'ì›';
const dartFmt  = v   => { if(!v)return'í™•ì¸ë¶ˆê°€'; const n=parseInt(String(v).replace(/,/g,'')); if(isNaN(n))return String(v); if(n>=1e12)return(n/1e12).toFixed(1)+'ì¡°ì›'; if(n>=1e8)return(n/1e8).toFixed(0)+'ì–µì›'; if(n>=1e4)return(n/1e4).toFixed(0)+'ë§Œì›'; return n.toLocaleString()+'ì›'; };
const domainOf = url => { try{ return new URL(url).hostname.replace('www.',''); }catch(e){ return url; } };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë¡œê·¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $lb = ()=>document.getElementById('logbox');
function log(m,t=''){
  const b=$lb(), d=document.createElement('div');
  d.className='ll'+(t?' '+t:'');
  d.textContent=`[${new Date().toLocaleTimeString('ko-KR',{hour12:false})}] ${m}`;
  b.appendChild(d); b.scrollTop=b.scrollHeight;
}
const clearLog=()=>{ $lb().innerHTML=''; };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì§„í–‰ UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST_URL=[
  'ğŸŒ URL í¬ë¡¤ë§ (í”„ë¡ì‹œ 3ë‹¨ê³„)',
  'ğŸ“„ Footer ì˜ì—­ ì¶”ì¶œ â†’ ì‚¬ì—…ì ì •ë³´ íŒŒì‹±',
  'ğŸ›ï¸ ìƒí’ˆ ì •ë³´ ìˆ˜ì§‘ â†’ ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„',
  'ğŸ›ï¸ êµ­ì„¸ì²­ API',
  'ğŸª ê³µì •ìœ„ API',
  'ğŸ“ˆ DART API',
  'âš™ï¸ ê·œì¹™ ì—”ì§„ ìë™ ì„ íƒ'
];
const ST_BIZ=[
  'ğŸ”¢ ì‚¬ì—…ìë²ˆí˜¸ ê²€ì¦',
  'ğŸ›ï¸ êµ­ì„¸ì²­ API',
  'ğŸª ê³µì •ìœ„ API',
  'ğŸ“ˆ DART API',
  'ğŸ¤– Geminië¡œ í™ˆí˜ì´ì§€ ê²€ìƒ‰',
  'ğŸŒ í™ˆí˜ì´ì§€ í¬ë¡¤ë§',
  'ğŸ¤– Gemini ìƒì„¸ ë¶„ì„',
  'âš™ï¸ ê·œì¹™ ì—”ì§„'
];

function setProg(ttl, steps, cur){
  document.getElementById('progTtl').textContent=ttl;
  document.getElementById('steps').innerHTML=steps.map((s,i)=>{
    const c=i<cur?'done':i===cur?'cur':'';
    return`<div class="stp ${c}"><span class="dot"></span>${i<cur?'âœ…':i===cur?'â³':'â—‹'} ${s}</div>`;
  }).join('');
  document.getElementById('prog').classList.add('on');
}
const hideProg=()=>document.getElementById('prog').classList.remove('on');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [1] HTML í¬ë¡¤ë§
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchHtml(url){
  log(`ğŸŒ í¬ë¡¤ë§: ${url}`);

  for(let i=0; i<PROXIES.length; i++){
    const pu = PROXIES[i](url);
    log(`ğŸ“¡ í”„ë¡ì‹œ ${i+1}...`,'i');
    try{
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 12000);
      const res=await fetch(pu,{signal:controller.signal});
      clearTimeout(timeoutId);
      if(!res.ok){ log(`âš ï¸ í”„ë¡ì‹œ ${i+1}: HTTP ${res.status}`,'w'); continue; }
      
      if(i===0){ // allorigins JSON
        const d=await res.json();
        const html=d.contents||'';
        if(html.length>200){ log(`âœ… allorigins JSON ì„±ê³µ â€” ${html.length.toLocaleString()}ì`); return html; }
      } else { // raw / corsproxy
        const html=await res.text();
        if(html.length>200 && html.includes('<')){ log(`âœ… í”„ë¡ì‹œ ${i+1} ì„±ê³µ â€” ${html.length.toLocaleString()}ì`); return html; }
      }
    }catch(e){ log(`âŒ í”„ë¡ì‹œ ${i+1}: ${e.message}`,'e'); }
  }

  // ì§ì ‘ fetch
  try{
    log('ğŸ“¡ ì§ì ‘ fetch...','i');
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    const res=await fetch(url,{mode:'cors',signal:controller.signal});
    clearTimeout(timeoutId);
    const html=await res.text();
    if(html.length>200){ log(`âœ… ì§ì ‘ fetch ì„±ê³µ!`); return html; }
  }catch(e){ log(`âŒ ì§ì ‘ fetch: ${e.message}`,'e'); }

  log('âš ï¸ ëª¨ë“  í¬ë¡¤ë§ ì‹¤íŒ¨','w');
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [2] Footer ì§‘ì¤‘ íŒŒì‹± (ì •í™•ë„ í–¥ìƒ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseHtml(html){
  if(!html) return { parsed: {}, products: [], siteDesc: '' };
  log('ğŸ“„ Footer ì˜ì—­ ì¶”ì¶œ...');

  // Footer ì˜ì—­ ìš°ì„  ì¶”ì¶œ
  let footerHtml = '';
  const footerPatterns = [
    /<footer[^>]*>([\s\S]*?)<\/footer>/i,
    /<div[^>]*class="[^"]*footer[^"]*"[^>]*>([\s\S]*?)<\/div>/i,
    /<div[^>]*id="footer"[^>]*>([\s\S]*?)<\/div>/i,
    /<div[^>]*class="[^"]*company[^"]*info[^"]*"[^>]*>([\s\S]*?)<\/div>/i,
    /<div[^>]*class="[^"]*bizinfo[^"]*"[^>]*>([\s\S]*?)<\/div>/i
  ];

  for(const pat of footerPatterns){
    const m = html.match(pat);
    if(m && m[1] && m[1].length > 100){
      footerHtml = m[1];
      log(`âœ… Footer ì˜ì—­ ë°œê²¬ (${footerHtml.length}ì)`);
      break;
    }
  }

  // Footer ì—†ìœ¼ë©´ HTML ì „ì²´ì—ì„œ í•˜ë‹¨ 30% ì‚¬ìš©
  if(!footerHtml){
    const bodyM = html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
    if(bodyM && bodyM[1]){
      const bodyHtml = bodyM[1];
      const cutPos = Math.floor(bodyHtml.length * 0.7); // í•˜ë‹¨ 30%
      footerHtml = bodyHtml.slice(cutPos);
      log(`â„¹ï¸ Footer íƒœê·¸ ì—†ìŒ â€” HTML í•˜ë‹¨ 30% ì‚¬ìš© (${footerHtml.length}ì)`,'i');
    } else {
      footerHtml = html.slice(Math.floor(html.length * 0.7));
      log(`â„¹ï¸ body íƒœê·¸ ì—†ìŒ â€” ì „ì²´ í•˜ë‹¨ 30% ì‚¬ìš©`,'i');
    }
  }

  // í…ìŠ¤íŠ¸ ì •ì œ
  const cleanText = txt => txt
    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi,'')
    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi,'')
    .replace(/<!--[\s\S]*?-->/g,'')
    .replace(/<[^>]+>/g,' ')
    .replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>')
    .replace(/\s+/g,' ');

  const footerText = cleanText(footerHtml);
  const fullText   = cleanText(html);

  log('ğŸ” ì •ê·œì‹ íŒŒì‹± ì‹œì‘...');

  const ex = (pats, source=footerText) => {
    for(const p of pats){
      const m = source.match(p);
      if(m && m[1] && m[1].trim()) return m[1].trim();
    }
    return null;
  };

  // Footerì—ì„œ ìš°ì„  ì¶”ì¶œ, ì—†ìœ¼ë©´ ì „ì²´ì—ì„œ ì°¾ê¸°
  const exBoth = pats => ex(pats, footerText) || ex(pats, fullText);

  // ì‚¬ì—…ìë²ˆí˜¸
  const bizNo = exBoth([
    /ì‚¬ì—…ì\s*ë“±ë¡\s*ë²ˆí˜¸\s*[:ï¼š]\s*(\d{3}[-\s]?\d{2}[-\s]?\d{5})/,
    /ì‚¬ì—…ìë²ˆí˜¸\s*[:ï¼š]\s*(\d{3}[-\s]?\d{2}[-\s]?\d{5})/,
    /ì‚¬ì—…ì\s*:\s*(\d{3}[-\s]?\d{2}[-\s]?\d{5})/,
    /(?:^|\s)(\d{3}[-\s]\d{2}[-\s]\d{5})(?=\s|$)/
  ])?.replace(/[\s-]/g, '').replace(/(\d{3})(\d{2})(\d{5})/, '$1-$2-$3');

  // ìƒí˜¸ëª…
  const company = exBoth([
    /(?:ë²•ì¸ëª…|ìƒí˜¸|íšŒì‚¬ëª…)\s*(?:[\(ï¼ˆ]ìƒí˜¸[\)ï¼‰])?\s*[:ï¼š]\s*([ê°€-í£a-zA-Z\s()\.&]{2,30}?)(?=\s*(?:ëŒ€í‘œ|ì‚¬ì—…ì|ì£¼ì†Œ|ì „í™”|\||$))/,
    /ìƒ\s*í˜¸\s*[:ï¼š]\s*([ê°€-í£a-zA-Z\s().&]{2,30})/
  ]);

  // ëŒ€í‘œì
  const ceo = exBoth([
    /ëŒ€í‘œ\s*ì?\s*(?:[\(ï¼ˆ]?ì„±ëª…[\)ï¼‰])?\s*[:ï¼š]\s*([ê°€-í£]{2,6})(?=\s|,|$|\|)/,
    /ëŒ€í‘œì´ì‚¬\s*[:ï¼š]\s*([ê°€-í£]{2,6})/,
    /CEO\s*[:ï¼š]\s*([ê°€-í£]{2,6})/,
    /ëŒ€\s*í‘œ\s*[:ï¼š]?\s*([ê°€-í£]{2,6})(?=\s|$|,)/
  ]);

  // í†µì‹ íŒë§¤ì—… ì‹ ê³ ë²ˆí˜¸
  const ecomm = exBoth([
    /í†µì‹ íŒë§¤ì—…\s*(?:ì‹ ê³ )?\s*(?:ë²ˆí˜¸|ì‹ ê³ ë²ˆí˜¸)\s*[:ï¼š]\s*(\d{4}-[ê°€-í£]+-\d+)/,
    /í†µì‹ íŒë§¤ì—…\s*[:ï¼š]\s*(\d{4}-[ê°€-í£]+-\d+)/,
    /ì œ\s*(\d{4}-[ê°€-í£]+-\d{4,5})\s*í˜¸/,
    /(\d{4}-[ê°€-í£]{2,6}-\d{4,5})/
  ]);

  // ì£¼ì†Œ
  const address = exBoth([
    /(?:ì£¼ì†Œ|ë³¸ì‚¬|ì‚¬ì—…ì¥)\s*[:ï¼š]\s*([ê°€-í£a-zA-Z0-9\s\-()]+?(?:íŠ¹ë³„ì‹œ|ê´‘ì—­ì‹œ|ë„|ì‹œ|êµ°|êµ¬)[ê°€-í£a-zA-Z0-9\s\-()]*?(?:ë¡œ|ê¸¸|ë™|ë²ˆì§€)[ê°€-í£0-9\s\-,()]{2,60})/,
    /(?:ì£¼ì†Œ|ë³¸ì‚¬)\s*[:ï¼š]\s*([ê°€-í£a-zA-Z0-9\s\-,()]+?(?:ë¡œ|ê¸¸|ë™)[ê°€-í£0-9\s\-,()]{2,60})/
  ]);

  // ì „í™”
  const phone = exBoth([
    /(?:ì „í™”|TEL|ê³ ê°ì„¼í„°|Tel)\s*[:ï¼š]\s*(0\d{1,2}[-\s]\d{3,4}[-\s]\d{4})/,
    /(?:ì „í™”|TEL)\s*[:ï¼š]\s*([\d\-]{9,14})/
  ]);

  // ì´ë©”ì¼
  const email = ex([/([a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/], fullText);

  const found = Object.entries({bizNo,company,ceo,ecomm,address,phone,email}).filter(([,v])=>v).map(([k])=>k);
  log(`ğŸ“‹ ì‚¬ì—…ì ì •ë³´: [${found.join(', ')||'ì—†ìŒ'}]`);

  // â”€â”€ ìƒí’ˆ ì •ë³´ ìˆ˜ì§‘ â”€â”€
  log('ğŸ›ï¸ ìƒí’ˆ ì •ë³´ ìˆ˜ì§‘...');
  
  // ìƒí’ˆëª…Â·ê°€ê²© íŒ¨í„´ (ë” ì •êµí•˜ê²Œ)
  const pricePattern = /(\d{1,3}(?:,\d{3})+)\s*ì›/g;
  const allPrices = [...fullText.matchAll(pricePattern)]
    .map(m => parseInt(m[1].replace(/,/g,'')))
    .filter(p => p >= 1000 && p <= 50_000_000);

  // HTMLì—ì„œ ìƒí’ˆ ì¹´ë“œ êµ¬ì¡° íŒŒì‹± ì‹œë„
  const products = [];
  const prodCardPatterns = [
    /<(?:div|li)[^>]*class="[^"]*(?:product|item|goods)[^"]*"[^>]*>([\s\S]{50,500}?)<\/(?:div|li)>/gi,
    /<(?:div|article)[^>]*(?:data-product|itemscope)[^>]*>([\s\S]{50,500}?)<\/(?:div|article)>/gi
  ];

  for(const pat of prodCardPatterns){
    const matches = [...html.matchAll(pat)];
    if(matches.length > 0){
      log(`ğŸ“¦ ìƒí’ˆ ì¹´ë“œ ${matches.length}ê°œ ë°œê²¬`);
      matches.slice(0, 15).forEach(m => {
        const cardHtml = m[1];
        const cardText = cleanText(cardHtml);
        
        // ê°€ê²© ì¶”ì¶œ
        const priceM = cardText.match(/(\d{1,3}(?:,\d{3})+)\s*ì›/);
        const price = priceM ? parseInt(priceM[1].replace(/,/g,'')) : null;
        
        // ìƒí’ˆëª… ì¶”ì¶œ (class="name", class="title", <a> íƒœê·¸ ë“±)
        let name = null;
        const namePatterns = [
          /class="[^"]*(?:name|title|product-name)[^"]*"[^>]*>([^<]{2,60})</i,
          /<a[^>]*>([^<]{5,60})<\/a>/i,
          /alt="([^"]{5,60})"/i
        ];
        for(const np of namePatterns){
          const nm = cardHtml.match(np);
          if(nm && nm[1]){
            name = nm[1].trim().replace(/\s+/g, ' ');
            break;
          }
        }
        
        if(price && price >= 1000 && price <= 50_000_000){
          products.push({ name: name || `ìƒí’ˆ ${products.length+1}`, price });
        }
      });
      break;
    }
  }

  // ìƒí’ˆ ì—†ìœ¼ë©´ ê°€ê²©ë§Œ ìˆ˜ì§‘
  if(products.length === 0 && allPrices.length > 0){
    log('â„¹ï¸ ìƒí’ˆ ì¹´ë“œ ë¯¸ë°œê²¬ â€” ê°€ê²©ë§Œ ìˆ˜ì§‘','i');
    allPrices.slice(0, 10).forEach((p, i) => {
      products.push({ name: `ìƒí’ˆ ${i+1}`, price: p });
    });
  }

  const avgPrice = allPrices.length > 0 
    ? Math.round(allPrices.reduce((a,b)=>a+b,0) / allPrices.length)
    : 30000;

  // ë°°ì†¡ì¼
  let avgShip = 5;
  const shipM = fullText.match(/(\d+)\s*(?:~\s*\d+)?\s*ì¼\s*(?:ì´ë‚´|ë‚´|ë°°ì†¡|ì¶œê³ |ì†Œìš”)/);
  if(shipM) avgShip = parseInt(shipM[1]);
  if(/ë‹¹ì¼\s*ë°°ì†¡|ì¦‰ì‹œ\s*ë°°ì†¡|ì˜¤ëŠ˜\s*ì¶œë°œ/i.test(fullText)) avgShip = 1;
  if(/í•´ì™¸\s*ë°°ì†¡|í•´ì™¸\s*ì§êµ¬|international/i.test(fullText) && avgShip < 7) avgShip = 14;

  // ìƒí’ˆ ìœ í˜• + ì¹´í…Œê³ ë¦¬ íŒë³„
  let productType = 'ì‹¤ë¬¼ìƒí’ˆ';
  let category = 'ì¼ë°˜ ìƒí’ˆ';
  
  if(/ìˆ™ë°•|í˜¸í…”|í•­ê³µ|ì—¬í–‰|ì˜ˆì•½|í‹°ì¼“|íœì…˜|ë¦¬ì¡°íŠ¸|ë Œíƒˆ|ë ŒíŠ¸ì¹´/i.test(fullText)){
    productType = 'ì˜ˆì•½ìƒí’ˆ';
    category = 'ì—¬í–‰Â·ìˆ™ë°•Â·í‹°ì¼“';
  } else if(/ì´ë¶|e-?book|ì „ìì±…|ë””ì§€í„¸|ì†Œí”„íŠ¸ì›¨ì–´|ì•±|app|ì½˜í…ì¸ |ìŒì›|ìŠ¤íŠ¸ë¦¬ë°/i.test(fullText)){
    productType = 'ë¹„ì‹¤ë¬¼ìƒí’ˆ';
    category = 'ë””ì§€í„¸ ì½˜í…ì¸ ';
  } else if(/ì˜ë¥˜|íŒ¨ì…˜|ì˜·|ì‹ ë°œ|ê°€ë°©|ì•¡ì„¸ì„œë¦¬/i.test(fullText)){
    category = 'íŒ¨ì…˜Â·ì˜ë¥˜';
  } else if(/ê°€ì „|ì „ì|ì»´í“¨í„°|íœ´ëŒ€í°|ìŠ¤ë§ˆíŠ¸í°|ë…¸íŠ¸ë¶/i.test(fullText)){
    category = 'ê°€ì „Â·ì „ìê¸°ê¸°';
  } else if(/ì‹í’ˆ|ìŒì‹|ë¨¹ê±°ë¦¬|ê°„ì‹|ê±´ê°•ì‹í’ˆ|ê±´ê°•|ì˜ì–‘ì œ/i.test(fullText)){
    category = 'ì‹í’ˆÂ·ê±´ê°•';
  } else if(/ê°€êµ¬|ì¸í…Œë¦¬ì–´|ë¦¬ë¹™|í™ˆë°ì½”|ì£¼ë°©|ìƒí™œ/i.test(fullText)){
    category = 'ê°€êµ¬Â·ë¦¬ë¹™';
  } else if(/í™”ì¥í’ˆ|ë·°í‹°|ë¯¸ìš©|ìŠ¤í‚¨ì¼€ì–´|ë©”ì´í¬ì—…/i.test(fullText)){
    category = 'ë·°í‹°Â·í™”ì¥í’ˆ';
  } else if(/ë„ì„œ|ì±…|ì„œì |ë¬¸êµ¬|êµìœ¡/i.test(fullText)){
    category = 'ë„ì„œÂ·ë¬¸êµ¬Â·êµìœ¡';
  }

  // ì‚¬ì´íŠ¸ íŠ¹ì„± ìë™ ì„¤ëª… ìƒì„±
  const siteDesc = `ì´ ì‡¼í•‘ëª°ì€ <strong>${category}</strong> ì¤‘ì‹¬ìœ¼ë¡œ íŒë§¤í•˜ëŠ” ${productType} ì „ë¬¸ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤. ` +
    `í‰ê·  ìƒí’ˆ ê°€ê²©ì€ <strong>${moneyFmt(avgPrice)}</strong>ì´ë©°, ` +
    `ë°°ì†¡ì€ í‰ê·  <strong>${avgShip}ì¼</strong> ì†Œìš”ë©ë‹ˆë‹¤. ` +
    `ì´ <strong>${products.length}ê°œ</strong>ì˜ ìƒí’ˆ ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.`;

  log(`ğŸ’° ìƒí’ˆ ë¶„ì„: í‰ê·  ${moneyFmt(avgPrice)}, ë°°ì†¡ ${avgShip}ì¼, ${category} (${productType})`);
  log(`ğŸ“¦ ìˆ˜ì§‘ ìƒí’ˆ: ${products.length}ê°œ`);

  // ì„¤ë¦½ì—°ë„
  const estYear = ecomm ? parseInt((ecomm.match(/^(\d{4})/)||[])[1]) : null;

  return {
    parsed: { bizNo, company, ceo, ecomm, address, phone, email, avgPrice, avgShip, productType, estYear },
    products,
    siteDesc,
    category
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [3] ê³µê³µ API (ë™ì¼)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function ntsCheck(bizNo){
  const clean = bizNo.replace(/\D/g,'');
  log(`ğŸ›ï¸ êµ­ì„¸ì²­: ${bizFmt(clean)}`);
  const KEY = 'DxPLsRV9OM7F9SrQwnL9dIqL3HsQXCi4Fb0PKpAqMV0Q1N%2Ft5DZEpC9gNibfXRbhiqFiymEnV3b8MqvITb5SKQ%3D%3D';
  try{
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 8000);
    const res = await fetch(`https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=${KEY}`,
      { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({b_no:[clean]}), signal:controller.signal });
    clearTimeout(timeoutId);
    if(res.ok){
      const d=await res.json(); const item=d?.data?.[0];
      if(item){
        const status=item.b_stt||'í™•ì¸ë¶ˆê°€', taxType=item.tax_type||'í™•ì¸ë¶ˆê°€';
        const cls=status.includes('ê³„ì†')?'ok':status.includes('íœ´ì—…')?'warn':'bad';
        log(`âœ… êµ­ì„¸ì²­: ${status}`); apiSt.nts='ok';
        return{status,taxType,cls};
      }
    }
  }catch(e){ log(`âš ï¸ êµ­ì„¸ì²­: ${e.message}`,'w'); }
  apiSt.nts='fail'; log('âš ï¸ êµ­ì„¸ì²­ ì‹¤íŒ¨ â€” ì‹œë®¬','w');
  return{status:'ê³„ì†ì‚¬ì—…ì (ì‹œë®¬)',taxType:'ì¼ë°˜ê³¼ì„¸ì (ì‹œë®¬)',cls:'ok',sim:true};
}

async function ftcCheck(bizNo){
  const clean=bizNo.replace(/\D/g,'');
  log(`ğŸª ê³µì •ìœ„: ${bizFmt(clean)}`);
  const KEY='DxPLsRV9OM7F9SrQwnL9dIqL3HsQXCi4Fb0PKpAqMV0Q1N%2Ft5DZEpC9gNibfXRbhiqFiymEnV3b8MqvITb5SKQ%3D%3D';
  try{
    const apiUrl=`https://apis.data.go.kr/1130000/MllBs_1Service/getMllBs_1List?serviceKey=${KEY}&brno=${clean}&pageNo=1&numOfRows=5&resultType=json`;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 12000);
    const res=await fetch(PROXIES[0](apiUrl),{signal:controller.signal});
    clearTimeout(timeoutId);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const outer=await res.json(); const d=JSON.parse(outer.contents||'{}');
    const items=d?.response?.body?.items?.item;
    const item=Array.isArray(items)?items[0]:items;
    if(item){
      const regNo=item.bmanEntrNo||item.corpEntrNo||null;
      const status=item.corpEntrSttsNm||item.bmanEntrSttsNm||'í™•ì¸ë¶ˆê°€';
      log(`âœ… ê³µì •ìœ„: ${regNo}`); apiSt.ftc='ok';
      return{regNo,status,company:item.companyCmpnmNm||null,ceo:item.rprsFnm||null,regDate:item.openBizDe||null};
    }
  }catch(e){ log(`âš ï¸ ê³µì •ìœ„: ${e.message}`,'w'); }
  apiSt.ftc='fail'; return{regNo:null,status:'ì¡°íšŒì‹¤íŒ¨',company:null,ceo:null,regDate:null,sim:true};
}

async function dartCheck(bizNo){
  const clean=bizNo.replace(/\D/g,'');
  log(`ğŸ“ˆ DART: ${bizFmt(clean)}`);
  const KEY='51ade8d029e9a41d87c48344b785b43a496743ac';
  try{
    const searchUrl=`https://opendart.fss.or.kr/api/company.json?crtfc_key=${KEY}&bizr_no=${clean}`;
    const controller1 = new AbortController();
    const timeoutId1 = setTimeout(() => controller1.abort(), 12000);
    const res=await fetch(PROXIES[0](searchUrl),{signal:controller1.signal});
    clearTimeout(timeoutId1);
    const outer=await res.json(); const d=JSON.parse(outer.contents||'{}');
    if(d?.status==='000'&&d.corp_code){
      log(`âœ… DART: ${d.corp_name}`);
      let fin=null;
      try{
        const fUrl=`https://opendart.fss.or.kr/api/fnlttSinglAcntAll.json?crtfc_key=${KEY}&corp_code=${d.corp_code}&bsns_year=2023&reprt_code=11011&fs_div=CFS`;
        const controller2 = new AbortController();
        const timeoutId2 = setTimeout(() => controller2.abort(), 12000);
        const fr=await fetch(PROXIES[0](fUrl),{signal:controller2.signal});
        clearTimeout(timeoutId2);
        const fo=await fr.json(); const fd=JSON.parse(fo.contents||'{}');
        if(fd?.list?.length>0){
          const get=label=>fd.list.find(i=>i.account_nm===label)?.thstrm_amount||null;
          fin={assets:get('ìì‚°ì´ê³„'),capital:get('ìë³¸ì´ê³„'),revenue:get('ë§¤ì¶œì•¡')||get('ì˜ì—…ìˆ˜ìµ'),netIncome:get('ë‹¹ê¸°ìˆœì´ìµ'),year:'2023'};
          log(`âœ… DART ì¬ë¬´: ${dartFmt(fin.revenue)}`);
        }
      }catch(fe){}
      apiSt.dart='ok';
      return{...d,financials:fin,isListed:!!d.stock_code};
    }
  }catch(e){ log(`âš ï¸ DART: ${e.message}`,'w'); }
  apiSt.dart='fail'; return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [5] Gemini APIë¡œ ì •ë³´ ë¶„ì„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function askGemini(prompt) {
  log('ğŸ¤– Gemini API í˜¸ì¶œ...');
  try {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000);
    
    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: prompt
          }]
        }],
        generationConfig: {
          temperature: 0.1,
          maxOutputTokens: 2048,
        }
      }),
      signal: controller.signal
    });
    
    clearTimeout(timeoutId);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const data = await response.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    
    if (text) {
      log(`âœ… Gemini ì‘ë‹µ ìˆ˜ì‹  (${text.length}ì)`);
      return text;
    }
    
    throw new Error('ì‘ë‹µ ë°ì´í„° ì—†ìŒ');
  } catch (e) {
    log(`âŒ Gemini API ì˜¤ë¥˜: ${e.message}`, 'e');
    return null;
  }
}

// Geminië¡œ ì‚¬ì—…ì ì •ë³´ ë¶„ì„ ë° í™ˆí˜ì´ì§€ ì°¾ê¸°
async function findWebsiteWithGemini(bizNo, companyName) {
  log('ğŸ¤– Geminië¡œ í™ˆí˜ì´ì§€ ê²€ìƒ‰...');
  
  const prompt = `ë‹¤ìŒ ì •ë³´ë¥¼ ê°€ì§„ í•œêµ­ ê¸°ì—…ì˜ ê³µì‹ í™ˆí˜ì´ì§€ URLì„ ì°¾ì•„ì£¼ì„¸ìš”:
- ì‚¬ì—…ìë²ˆí˜¸: ${bizFmt(bizNo)}
${companyName ? `- íšŒì‚¬ëª…: ${companyName}` : ''}

ìš”êµ¬ì‚¬í•­:
1. ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ” ê³µì‹ í™ˆí˜ì´ì§€ URLë§Œ ì œê³µ
2. ì‡¼í•‘ëª°ì´ë‚˜ ì˜¨ë¼ì¸ íŒë§¤ ì‚¬ì´íŠ¸ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì°¾ê¸°
3. ë¸”ë¡œê·¸, SNS, ë§ˆì¼“í”Œë ˆì´ìŠ¤(ë„¤ì´ë²„ ìŠ¤í† ì–´íŒœ, ì¿ íŒ¡ ë“±)ëŠ” ì œì™¸
4. URLë§Œ ê°„ë‹¨íˆ ë‹µë³€ (ì„¤ëª… ë¶ˆí•„ìš”)

í˜•ì‹: https://example.com ë˜ëŠ” "ì°¾ì„ ìˆ˜ ì—†ìŒ"`;

  const response = await askGemini(prompt);
  
  if (!response) return null;
  
  // URL ì¶”ì¶œ
  const urlMatch = response.match(/https?:\/\/[^\s<>"{}|\\^`\[\]]+/);
  if (urlMatch) {
    const url = urlMatch[0].replace(/[,.)]+$/, ''); // ëì˜ êµ¬ë‘ì  ì œê±°
    log(`âœ… Geminiê°€ ì°¾ì€ URL: ${url}`);
    
    // URL ìœ íš¨ì„± ê²€ì¦
    try {
      const domain = new URL(url).hostname.toLowerCase();
      const excludeDomains = ['naver', 'smartstore', 'coupang', 'gmarket', 'auction', '11st', 'instagram', 'facebook', 'blog', 'cafe'];
      
      if (excludeDomains.some(ex => domain.includes(ex))) {
        log('âš ï¸ ë§ˆì¼“í”Œë ˆì´ìŠ¤/SNS URL ì œì™¸', 'w');
        return null;
      }
      
      return url;
    } catch (e) {
      log(`âš ï¸ ì˜ëª»ëœ URL í˜•ì‹: ${url}`, 'w');
      return null;
    }
  }
  
  log('âš ï¸ Geminiê°€ URLì„ ì°¾ì§€ ëª»í•¨', 'w');
  return null;
}

// Geminië¡œ HTML ì½˜í…ì¸  ë¶„ì„ ê°•í™”
async function analyzeWithGemini(html, bizInfo) {
  log('ğŸ¤– Geminië¡œ ìƒì„¸ ë¶„ì„...');
  
  // HTMLì—ì„œ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (ê°„ë‹¨íˆ)
  const text = html
    .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
    .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
    .replace(/<[^>]+>/g, ' ')
    .replace(/\s+/g, ' ')
    .slice(0, 5000); // ì²˜ìŒ 5000ìë§Œ
  
  const prompt = `ë‹¤ìŒì€ í•œêµ­ ì‡¼í•‘ëª° ì›¹ì‚¬ì´íŠ¸ì˜ í…ìŠ¤íŠ¸ ë‚´ìš©ì…ë‹ˆë‹¤. ë¶„ì„í•´ì„œ JSON í˜•ì‹ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”:

${text}

ë¶„ì„ í•­ëª©:
1. category: ì£¼ìš” íŒë§¤ ì¹´í…Œê³ ë¦¬ (ì˜ˆ: "íŒ¨ì…˜Â·ì˜ë¥˜", "ê°€ì „Â·ì „ìê¸°ê¸°", "ì‹í’ˆÂ·ê±´ê°•" ë“±)
2. productType: ìƒí’ˆ ìœ í˜• ("ì‹¤ë¬¼ìƒí’ˆ", "ì˜ˆì•½ìƒí’ˆ", "ë¹„ì‹¤ë¬¼ìƒí’ˆ" ì¤‘ í•˜ë‚˜)
3. description: ì´ ì‡¼í•‘ëª°ì— ëŒ€í•œ í•œ ì¤„ ì„¤ëª… (50ì ì´ë‚´)

JSONë§Œ ë‹µë³€í•˜ì„¸ìš”:
{"category": "...", "productType": "...", "description": "..."}`;

  const response = await askGemini(prompt);
  
  if (!response) return null;
  
  try {
    // JSON ì¶”ì¶œ
    const jsonMatch = response.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      const data = JSON.parse(jsonMatch[0]);
      log(`âœ… Gemini ë¶„ì„: ${data.category} / ${data.productType}`);
      return data;
    }
  } catch (e) {
    log(`âš ï¸ Gemini ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${e.message}`, 'w');
  }
  
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [5-êµ¬ë²„ì „] êµ¬ê¸€ ê²€ìƒ‰ìœ¼ë¡œ í™ˆí˜ì´ì§€ ì°¾ê¸° (ë°±ì—…ìš©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function findWebsiteByBizNo(bizNo, companyName){
  log('ğŸ” êµ¬ê¸€ ê²€ìƒ‰ìœ¼ë¡œ í™ˆí˜ì´ì§€ ì°¾ê¸°...');
  
  // ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±
  const queries = [];
  if(companyName) {
    queries.push(`${companyName} í™ˆí˜ì´ì§€`);
    queries.push(`${companyName} ì‡¼í•‘ëª°`);
    queries.push(`${companyName} ê³µì‹ ì‚¬ì´íŠ¸`);
  }
  queries.push(`${bizFmt(bizNo)} í™ˆí˜ì´ì§€`);
  
  for(const query of queries) {
    try {
      log(`ğŸ” ê²€ìƒ‰: "${query}"`);
      
      // Google Custom Search API ëŒ€ì‹  ì§ì ‘ ê²€ìƒ‰ í˜ì´ì§€ í¬ë¡¤ë§
      const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
      
      for(let i = 0; i < PROXIES.length; i++) {
        try {
          const proxyUrl = PROXIES[i](searchUrl);
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);
          
          const res = await fetch(proxyUrl, {
            signal: controller.signal,
            headers: {
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
          });
          clearTimeout(timeoutId);
          
          if(!res.ok) continue;
          
          let html;
          if(i === 0) {
            const d = await res.json();
            html = d.contents || '';
          } else {
            html = await res.text();
          }
          
          if(!html || html.length < 100) continue;
          
          // HTMLì—ì„œ URL ì¶”ì¶œ
          const urlPatterns = [
            /https?:\/\/(?:www\.)?([a-zA-Z0-9][-a-zA-Z0-9]*[a-zA-Z0-9]\.)+[a-zA-Z]{2,}/g
          ];
          
          const foundUrls = new Set();
          for(const pattern of urlPatterns) {
            const matches = html.matchAll(pattern);
            for(const match of matches) {
              foundUrls.add(match[0]);
            }
          }
          
          // URL í•„í„°ë§ (ì‡¼í•‘ëª°/íšŒì‚¬ ì‚¬ì´íŠ¸ë¡œ ë³´ì´ëŠ” ê²ƒ)
          const excludeDomains = [
            'google', 'youtube', 'facebook', 'instagram', 'twitter',
            'naver', 'daum', 'kakao', 'blog', 'tistory', 'wiki',
            'gov.kr', 'go.kr'
          ];
          
          for(const url of foundUrls) {
            try {
              const domain = new URL(url).hostname.toLowerCase();
              
              // ì œì™¸ ë„ë©”ì¸ ì²´í¬
              if(excludeDomains.some(ex => domain.includes(ex))) continue;
              
              // .com, .co.kr, .kr ë“± ìœ íš¨í•œ ë„ë©”ì¸ë§Œ
              if(!domain.match(/\.(com|co\.kr|kr|net|shop|store|mall)$/)) continue;
              
              log(`âœ… ë°œê²¬ëœ URL: ${url}`, 'i');
              return url;
            } catch(e) {
              continue;
            }
          }
          
          break; // í”„ë¡ì‹œ ì„±ê³µí•˜ë©´ ë‹¤ìŒ ì¿¼ë¦¬ë¡œ
        } catch(e) {
          log(`âš ï¸ í”„ë¡ì‹œ ${i+1} ì‹¤íŒ¨: ${e.message}`, 'w');
        }
      }
    } catch(e) {
      log(`âš ï¸ ê²€ìƒ‰ ì‹¤íŒ¨: ${e.message}`, 'w');
    }
  }
  
  log('âš ï¸ í™ˆí˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤', 'w');
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// [4] ê·œì¹™ ì—”ì§„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ruleEngine(parsed, nts, ftc, dart){
  log('âš™ï¸ ê·œì¹™ ì—”ì§„...');

  const ship = parsed.avgShip || 5;
  const shipIdx = ship<3?0 : ship<7?1 : ship<15?2 : ship<30?3 : 4;
  sel[6]={idx:shipIdx,auto:false};
  log(`ğŸšš ë°°ì†¡ì£¼ê¸°: ${ship}ì¼ â†’ ${CATS[6].ranges[shipIdx].l}`);

  const price = parsed.avgPrice || 30000;
  const priceIdx = price<50000?0 : price<100000?1 : price<300000?2 : price<500000?3 : 4;
  sel[7]={idx:priceIdx,auto:false};
  log(`ğŸ’° ê°ë‹¨ê°€: ${moneyFmt(price)} â†’ ${CATS[7].ranges[priceIdx].l}`);

  const ptMap={'ì‹¤ë¬¼ìƒí’ˆ':0,'ì˜ˆì•½ìƒí’ˆ':1,'ë¹„ì‹¤ë¬¼ìƒí’ˆ':2};
  const ptIdx = ptMap[parsed.productType]??0;
  sel[8]={idx:ptIdx,auto:false};
  log(`ğŸ“¦ ìƒí’ˆìœ í˜•: ${parsed.productType}`);

  sel[3]={idx:2,auto:false};
  log(`ğŸŒ êµ­ì : ì €ìœ„í—˜(í•œêµ­)`);

  const regDate = ftc?.regDate;
  const estYear = parsed.estYear || (regDate ? parseInt(regDate.slice(0,4)) : null);
  if(estYear){
    const yrs = new Date().getFullYear() - estYear;
    const yIdx = yrs<1?0 : yrs<5?1 : yrs<10?2 : 3;
    sel[5]={idx:yIdx,auto:false};
    log(`ğŸ“… ì‚¬ì—…ë…„ìˆ˜: ${yrs}ë…„ â†’ ${CATS[5].ranges[yIdx].l}`);
  } else {
    sel[5]={idx:0,auto:true};
    unv.push({name:CATS[5].name,range:CATS[5].ranges[0].l,score:0,reason:'ì„¤ë¦½ì¼ ë¯¸í™•ì¸'});
    log('âš ï¸ ì‚¬ì—…ë…„ìˆ˜ ë¯¸í™•ì¸','w');
  }

  sel[4]={idx:1,auto:true};
  unv.push({name:CATS[4].name,range:CATS[4].ranges[1].l,score:1,reason:'ìƒë…„ì›”ì¼ ê³µê³µAPI í™•ì¸ë¶ˆê°€'});
  log('âš ï¸ ëŒ€í‘œì ë‚˜ì´ ë¯¸í™•ì¸','w');

  if(dart?.financials){
    const f=dart.financials;
    const toNum = v => parseInt(String(v||0).replace(/,/g,''));
    const cap = toNum(f.capital), rev = toNum(f.revenue), ni = toNum(f.netIncome);
    const capIdx = cap<1e8?0 : cap<1e9?1 : cap<1e10?2 : cap<1e11?3 : 4;
    sel[0]={idx:capIdx,auto:false};
    log(`ğŸ’ ìë³¸ê¸ˆ: ${dartFmt(f.capital)} â†’ ${CATS[0].ranges[capIdx].l}`);
    const revIdx = rev<1e8?0 : rev<1e9?1 : rev<1e10?2 : rev<1e11?3 : 4;
    sel[1]={idx:revIdx,auto:false};
    log(`ğŸ“ˆ ë§¤ì¶œì•¡: ${dartFmt(f.revenue)} â†’ ${CATS[1].ranges[revIdx].l}`);
    const margin = rev>0 ? ni/rev : 0;
    const gIdx = margin>=0.1?3 : margin>=0.03?2 : margin>=0?1 : 0;
    sel[2]={idx:gIdx,auto:false};
    log(`ğŸ¢ ê¸°ì—…ë“±ê¸‰: ìˆœì´ìµë¥  ${(margin*100).toFixed(1)}% â†’ ${CATS[2].ranges[gIdx].l}`);
  } else {
    [[0,0,'ì¬ë¬´ì •ë³´ ì—†ìŒ (DART ë¯¸ê³µì‹œ)'],[1,0,'ì¬ë¬´ì •ë³´ ì—†ìŒ'],[2,1,'cë“±ê¸‰ ê¸°ë³¸']].forEach(([id,idx,reason])=>{
      sel[id]={idx,auto:true};
      unv.push({name:CATS[id].name,range:CATS[id].ranges[idx].l,score:CATS[id].ranges[idx].s,reason});
    });
    log('âš ï¸ DART ì—†ìŒ','w');
  }

  log(`âœ… ê·œì¹™ ì—”ì§„ ì™„ë£Œ â€” ë¯¸í™•ì¸ ${unv.length}ê°œ`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë©”ì¸ í”Œë¡œìš° â€” URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doUrl(){
  let url = document.getElementById('urlInp').value.trim();
  if(!url){ alert('URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  if(!url.startsWith('http')) url='https://'+url;
  document.getElementById('urlInp').value=url;

  const btn=document.getElementById('btnUrl');
  btn.disabled=true; btn.textContent='ë¶„ì„ ì¤‘...';
  clearLog(); unv=[]; sel={}; apiSt={};
  
  // UI ì´ˆê¸°í™”
  document.getElementById('siteAnal').style.display='none';
  document.getElementById('bizCard').classList.remove('on');
  document.getElementById('alertBox').classList.remove('on');

  try{
    // [1] í¬ë¡¤ë§
    setProg('URL í¬ë¡¤ë§...',ST_URL,0);
    const html = await fetchHtml(url);

    // [2] Footer íŒŒì‹± + ìƒí’ˆ ìˆ˜ì§‘
    setProg('Footer & ìƒí’ˆ ë¶„ì„...',ST_URL,1);
    const result = parseHtml(html);
    const parsed = result.parsed;
    const products = result.products;
    const siteDesc = result.siteDesc;
    const category = result.category;

    // [3] ì‚¬ì´íŠ¸ íŠ¹ì„± í‘œì‹œ
    setProg('ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„...',ST_URL,2);
    showSiteAnalysis(siteDesc, category, parsed, products);

    let nts=null, ftc=null, dart=null;

    if(parsed.bizNo){
      log(`ğŸ“‹ ì‚¬ì—…ìë²ˆí˜¸: ${bizFmt(parsed.bizNo)}`);
      setProg('êµ­ì„¸ì²­ API...',ST_URL,3); nts  = await ntsCheck(parsed.bizNo);
      setProg('ê³µì •ìœ„ API...',ST_URL,4); ftc  = await ftcCheck(parsed.bizNo);
      setProg('DART API...',  ST_URL,5); dart = await dartCheck(parsed.bizNo);
    } else {
      log('âš ï¸ ì‚¬ì—…ìë²ˆí˜¸ ë¯¸ì¶”ì¶œ','w');
      apiSt={nts:'skip',ftc:'skip',dart:'skip'};
    }

    // [4] ê·œì¹™ ì—”ì§„
    setProg('ê·œì¹™ ì—”ì§„...',ST_URL,6);
    ruleEngine(parsed, nts, ftc, dart);

    lastInfo={...parsed,nts,ftc,dart,url,category};
    hideProg();
    showBizCard(lastInfo);
    showAlert();
    renderCats();
    calc();

    popup(unv.length?'âš ï¸':'âœ…',
      unv.length?`ë¶„ì„ ì™„ë£Œ!\n${unv.length}ê°œ í•­ëª© ì§ì ‘ í™•ì¸ í•„ìš”`:'âœ… ìë™ ë¶„ì„ ì™„ë£Œ!');

  }catch(e){
    log(`âŒ ì˜¤ë¥˜: ${e.message}`,'e');
    hideProg();
    popup('âŒ',`ì˜¤ë¥˜\n${e.message}`);
  }

  btn.disabled=false; btn.textContent='ğŸš€ ë¶„ì„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ë©”ì¸ í”Œë¡œìš° â€” ì‚¬ì—…ìë²ˆí˜¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doBiz(){
  const clean=document.getElementById('bizInp').value.replace(/\D/g,'');
  if(clean.length!==10){ alert('ì˜¬ë°”ë¥¸ ì‚¬ì—…ìë²ˆí˜¸(10ìë¦¬)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const btn=document.getElementById('btnBiz');
  btn.disabled=true; btn.textContent='ë¶„ì„ ì¤‘...';
  clearLog(); unv=[]; sel={}; apiSt={};
  
  // UI ì´ˆê¸°í™”
  document.getElementById('siteAnal').style.display='none';
  document.getElementById('bizCard').classList.remove('on');
  document.getElementById('alertBox').classList.remove('on');

  try{
    setProg('ì‚¬ì—…ìë²ˆí˜¸ ê²€ì¦...',ST_BIZ,0);
    log(`ğŸ”¢ ${bizFmt(clean)}`); await sleep(300);

    setProg('êµ­ì„¸ì²­ API...',ST_BIZ,1); const nts  = await ntsCheck(clean);
    setProg('ê³µì •ìœ„ API...',ST_BIZ,2); const ftc  = await ftcCheck(clean);
    setProg('DART API...',  ST_BIZ,3); const dart = await dartCheck(clean);

    let parsed={
      bizNo:clean, company:ftc?.company||null, ceo:ftc?.ceo||null,
      ecomm:ftc?.regNo||null, avgPrice:30000, avgShip:5,
      productType:'ì‹¤ë¬¼ìƒí’ˆ',
      estYear: ftc?.regDate ? parseInt(ftc.regDate.slice(0,4)) : null
    };

    // ğŸ¤– Gemini APIë¡œ í™ˆí˜ì´ì§€ ì°¾ê¸°
    setProg('Geminië¡œ í™ˆí˜ì´ì§€ ê²€ìƒ‰...',ST_BIZ,4);
    log('ğŸ¤– Gemini APIë¡œ í™ˆí˜ì´ì§€ ì°¾ê¸°...');
    let foundUrl = await findWebsiteWithGemini(clean, ftc?.company);
    
    // Gemini ì‹¤íŒ¨ ì‹œ êµ¬ê¸€ ê²€ìƒ‰ ë°±ì—…
    if(!foundUrl) {
      log('âš ï¸ Gemini ì‹¤íŒ¨ - êµ¬ê¸€ ê²€ìƒ‰ìœ¼ë¡œ ì „í™˜', 'w');
      foundUrl = await findWebsiteByBizNo(clean, ftc?.company);
    }
    
    let siteDesc = null;
    let category = null;
    let products = [];
    
    if(foundUrl) {
      log(`âœ… í™ˆí˜ì´ì§€ ë°œê²¬: ${foundUrl}`);
      
      // í™ˆí˜ì´ì§€ í¬ë¡¤ë§ ë° ë¶„ì„
      setProg('í™ˆí˜ì´ì§€ í¬ë¡¤ë§...',ST_BIZ,5);
      const html = await fetchHtml(foundUrl);
      
      if(html) {
        log('ğŸ“„ í™ˆí˜ì´ì§€ ë¶„ì„ ì¤‘...');
        const result = parseHtml(html);
        parsed = { ...parsed, ...result.parsed };
        products = result.products;
        siteDesc = result.siteDesc;
        category = result.category;
        
        // ğŸ¤– Geminië¡œ ì¶”ê°€ ë¶„ì„
        setProg('Gemini ìƒì„¸ ë¶„ì„...',ST_BIZ,6);
        const geminiAnalysis = await analyzeWithGemini(html, parsed);
        if(geminiAnalysis) {
          category = geminiAnalysis.category || category;
          parsed.productType = geminiAnalysis.productType || parsed.productType;
          if(geminiAnalysis.description) {
            siteDesc = geminiAnalysis.description + ' ' + siteDesc;
          }
          log(`âœ… Gemini ë¶„ì„ ì ìš©: ${category}`);
        }
        
        // ì‚¬ì´íŠ¸ íŠ¹ì„± í‘œì‹œ
        showSiteAnalysis(siteDesc, category, parsed, products);
      }
    } else {
      log('âš ï¸ í™ˆí˜ì´ì§€ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ - ê¸°ë³¸ê°’ìœ¼ë¡œ ì§„í–‰', 'w');
    }

    setProg('ê·œì¹™ ì—”ì§„...',ST_BIZ,7);
    ruleEngine(parsed,nts,ftc,dart);

    lastInfo={...parsed,nts,ftc,dart,url:foundUrl||`ì‚¬ì—…ìë²ˆí˜¸: ${bizFmt(clean)}`,category};
    hideProg();
    showBizCard(lastInfo);
    showAlert(); renderCats(); calc();
    
    if(foundUrl) {
      popup('âœ…',`ğŸ¤– Gemini ë¶„ì„ ì™„ë£Œ!\ní™ˆí˜ì´ì§€: ${domainOf(foundUrl)}`);
    } else {
      popup('âš ï¸',`ì‚¬ì—…ìë²ˆí˜¸ ë¶„ì„ ì™„ë£Œ\ní™ˆí˜ì´ì§€ ë¯¸ë°œê²¬`);
    }

  }catch(e){
    log(`âŒ ${e.message}`,'e'); hideProg();
    popup('âŒ',`ì˜¤ë¥˜\n${e.message}`);
  }
  btn.disabled=false; btn.textContent='ğŸš€ ë¶„ì„';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì‚¬ì´íŠ¸ íŠ¹ì„± ë¶„ì„ í‘œì‹œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSiteAnalysis(desc, category, parsed, products){
  const el = document.getElementById('siteAnal');
  document.getElementById('siteDesc').innerHTML = desc;

  // ë©”íƒ€ ì •ë³´
  document.getElementById('siteMeta').innerHTML = [
    { l:'ìƒí’ˆ ì¹´í…Œê³ ë¦¬', v: category },
    { l:'í‰ê·  ê°ë‹¨ê°€',   v: moneyFmt(parsed.avgPrice) },
    { l:'í‰ê·  ë°°ì†¡ì¼',   v: parsed.avgShip + 'ì¼' },
    { l:'ìƒí’ˆ ìœ í˜•',     v: parsed.productType },
    { l:'ìˆ˜ì§‘ ìƒí’ˆ ìˆ˜',  v: products.length + 'ê°œ' }
  ].map(m => `<div class="sm-item">
    <div class="sm-lbl">${m.l}</div>
    <div class="sm-val">${m.v}</div>
  </div>`).join('');

  // ìƒí’ˆ ëª©ë¡
  const maxProducts = 12;
  document.getElementById('prodList').innerHTML = products.slice(0, maxProducts).map(p =>
    `<div class="prod-item">
      <div class="prod-name" title="${p.name}">${p.name}</div>
      <div class="prod-price">${p.price.toLocaleString()}ì›</div>
      <div class="prod-cat">${category}</div>
    </div>`
  ).join('') + (products.length > maxProducts ?
    `<div class="prod-item" style="grid-column:1/-1;text-align:center;color:var(--g400);font-size:12px">
      ì™¸ ${products.length - maxProducts}ê°œ ìƒí’ˆ...
    </div>` : '');

  el.style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// íšŒì‚¬ ì¹´ë“œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showBizCard(info){
  const name = info.ftc?.company || info.company || info.url || '-';
  document.getElementById('dispName').textContent = name;

  const sub=[];
  if(info.ftc?.regDate) sub.push(`í†µì‹ íŒë§¤ì—…: ${info.ftc.regDate}`);
  if(info.dart?.corp_name) sub.push(`DART: ${info.dart.corp_name}`);
  if(info.category) sub.push(info.category);
  document.getElementById('dispSub').textContent = sub.join(' Â· ') || info.url || '-';

  document.getElementById('vBadge').style.display =
    (apiSt.nts==='ok'||apiSt.ftc==='ok') ? 'block' : 'none';

  const cells=[
    {l:'ìƒí˜¸ëª…',            v:info.ftc?.company||info.company},
    {l:'ëŒ€í‘œìëª…',          v:info.ftc?.ceo||info.ceo},
    {l:'ì‚¬ì—…ìë²ˆí˜¸',        v:info.bizNo?bizFmt(info.bizNo):null},
    {l:'êµ­ì„¸ì²­ ì‚¬ì—…ììƒíƒœ', v:info.nts?.status, c:info.nts?.cls},
    {l:'ê³¼ì„¸ìœ í˜•',          v:info.nts?.taxType},
    {l:'í†µì‹ íŒë§¤ì—…',        v:info.ftc?.regNo||info.ecomm},
    {l:'í†µì‹ íŒë§¤ì—… ìƒíƒœ',   v:info.ftc?.status,
      c:info.ftc?.status?.includes('ì‹ ê³ ')?'ok':info.ftc?.status?'warn':''},
    {l:'í†µì‹ íŒë§¤ì—… ì‹ ê³ ì¼', v:info.ftc?.regDate},
    {l:'DART',
      v:info.dart?.isListed?`ìƒì¥ (${info.dart.stock_code})`:info.dart?.corp_name?`ë¹„ìƒì¥`:'-'},
    {l:'ì£¼ì†Œ',      v:info.address},
    {l:'ì „í™”',      v:info.phone},
    {l:'ì´ë©”ì¼',    v:info.email}
  ];

  let gridHtml = cells.map(c=>{
    const v = c.v||'í™•ì¸ë¶ˆê°€';
    const cls = c.c||(c.v?'':'gray');
    return`<div class="bc"><div class="bc-l">${c.l}</div><div class="bc-v ${cls}">${v}</div></div>`;
  }).join('');

  if(info.dart?.financials){
    const f=info.dart.financials;
    gridHtml+=`<div class="bc" style="grid-column:1/-1;background:#f0fdf4">
      <div class="bc-l" style="color:var(--green)">ğŸ“ˆ DART ì¬ë¬´ (${f.year})</div>
      <div style="display:flex;gap:18px;flex-wrap:wrap;margin-top:5px;font-size:13px;font-weight:600">
        ${f.assets   ?`<span>ìì‚° ${dartFmt(f.assets)}</span>`:''}
        ${f.capital  ?`<span>ìë³¸ ${dartFmt(f.capital)}</span>`:''}
        ${f.revenue  ?`<span>ë§¤ì¶œ ${dartFmt(f.revenue)}</span>`:''}
        ${f.netIncome?`<span>ìˆœì´ìµ ${dartFmt(f.netIncome)}</span>`:''}
      </div>
    </div>`;
  }
  document.getElementById('bgrid').innerHTML = gridHtml;

  document.getElementById('abar').innerHTML =
    [{l:'êµ­ì„¸ì²­',k:'nts'},{l:'ê³µì •ìœ„',k:'ftc'},{l:'DART',k:'dart'}].map(b=>{
      const s=apiSt[b.k]||'skip';
      const icon=s==='ok'?'âœ…':s==='fail'?'âŒ':'â­ï¸';
      return`<div class="src-chip ${s}">${icon} ${b.l}</div>`;
    }).join('')+`<div class="src-chip ok">ğŸ¤– Gemini AI</div>`;

  document.getElementById('bizCard').classList.add('on');
}

function showAlert(){
  const el=document.getElementById('alertBox');
  if(!unv.length){ el.classList.remove('on'); return; }
  document.getElementById('alertList').innerHTML=unv.map(u=>
    `<li>âš ï¸ <strong>${u.name}</strong>: "${u.range}" (${u.score}ì ) â€” ${u.reason}</li>`
  ).join('');
  el.classList.add('on');
}

function renderCats(){
  document.getElementById('catArea').innerHTML=CATS.map(cat=>{
    const isUnv=unv.some(u=>u.name===cat.name);
    const s=sel[cat.id];
    return`<div class="cat ${isUnv?'unv':''}">
      <div class="cat-hd">
        <div class="cat-ttl">
          ${isUnv?'âš ï¸ ':''}${cat.name}
          <span class="wb">Ã—${cat.w}</span>
          ${isUnv?'<span class="ut">í™•ì¸ í•„ìš”</span>':''}
        </div>
      </div>
      <div class="rg">${cat.ranges.map((r,ri)=>{
        const isSel=s?.idx===ri, isAuto=s?.auto&&isSel;
        return`<button class="rb ${isAuto?'autosel':isSel?'sel':''}" onclick="pick(${cat.id},${ri})">
          <span class="rb-n">${r.l}</span>
          <span class="rb-s">${r.s>=0?'+':''}${r.s}ì </span>
        </button>`;
      }).join('')}</div>
    </div>`;
  }).join('');
}

function pick(catId,idx){
  sel[catId]={idx,auto:false};
  unv=unv.filter(u=>u.name!==CATS[catId].name);
  showAlert(); renderCats(); calc();
}

function calc(){
  let total=0, base=0;
  Object.keys(sel).forEach(id=>{
    const cid=parseInt(id);
    const w=CATS[cid].w, s=CATS[cid].ranges[sel[cid].idx].s;
    total+=s*w; if(cid<=5) base+=s*w;
  });

  const limit=getLimit();
  const ratio=getCollRatio(total);
  const coll=Math.round(limit*ratio);
  const grade=getGrade(base);
  const mon=getMon(grade);

  document.getElementById('totalScore').innerHTML=`${total}<span style="font-size:18px">ì </span>`;
  document.getElementById('rLimit').textContent=limit?moneyFmt(limit):'-';
  document.getElementById('rColl').textContent =limit?moneyFmt(coll) :'-';
  updateGrade(grade,base,mon);
  updateRev(total,base,grade,limit,coll);
  renderColl(total);
}

const getCollRatio = s=>{ let r=COLL_TBL[0].r; for(const row of COLL_TBL) if(s>=row.min) r=row.r; return r; };
const getGrade     = b=>{ let g=GRADE_TBL[0]; for(const row of GRADE_TBL) if(b>=row.min) g=row; return g; };
const getMon       = grade=>{ if(grade.g==='í˜‘ì˜ í•„ìš”')return{lv:'ê°œë³„í˜‘ì˜',fr:'ì¼€ì´ìŠ¤ë³„'}; const n=parseInt(grade.g); return MON_TBL[n]||{lv:'-',fr:'-'}; };

function updateGrade(grade,base,mon){
  const b=document.getElementById('gBadge');
  ['g1','g2','g3','g4','g5','g6','gc'].forEach(c=>b.classList.remove(c));
  if(grade.g==='í˜‘ì˜ í•„ìš”'){ b.classList.add('gc'); b.textContent='í˜‘ì˜ í•„ìš”'; }
  else{ const n=parseInt(grade.g); b.classList.add('g'+(isNaN(n)?'c':n)); b.textContent=grade.g; }
  document.getElementById('gMon').textContent     = mon.lv+' ëª¨ë‹ˆí„°ë§';
  document.getElementById('baseScore').textContent= base;
  document.getElementById('monLv').textContent    = mon.lv;
  document.getElementById('monFr').textContent    = mon.fr;
}

function updateRev(total,base,grade,limit,coll){
  const secs=[];
  if(unv.length) secs.push({t:'âš ï¸ í™•ì¸ í•„ìš”',
    b:unv.map(u=>`â€¢ <strong>${u.name}</strong>: ${u.range} (${u.score}ì ) â€” ${u.reason}`).join('<br>')});

  if(lastInfo){
    const i=lastInfo, lines=[];
    if(i.ftc?.company||i.company) lines.push(`â€¢ ìƒí˜¸: ${i.ftc?.company||i.company}`);
    if(i.bizNo) lines.push(`â€¢ ì‚¬ì—…ì: ${bizFmt(i.bizNo)}`);
    if(i.nts?.status){
      const s=i.nts.status;
      lines.push(`${s.includes('ê³„ì†')?'âœ…':s.includes('íœ´ì—…')?'âš ï¸':'âŒ'} êµ­ì„¸ì²­: ${s}`);
    }
    lines.push(i.ftc?.regNo?`âœ… í†µì‹ íŒë§¤ì—…: ${i.ftc.regNo}`:'âš ï¸ í†µì‹ íŒë§¤ì—… ë¯¸í™•ì¸');
    if(i.dart?.corp_name) lines.push(`ğŸ“ˆ DART: ${i.dart.corp_name}`);
    if(i.category) lines.push(`ğŸª ì¹´í…Œê³ ë¦¬: ${i.category}`);
    secs.push({t:'ğŸ¢ ì‚¬ì—…ì ì •ë³´',b:lines.join('<br>')});
  }

  if(lastInfo?.avgPrice) secs.push({t:'ğŸ›ï¸ ìƒí’ˆ ë¶„ì„',
    b:`â€¢ ê°ë‹¨ê°€: <strong>${moneyFmt(lastInfo.avgPrice)}</strong><br>
       â€¢ ë°°ì†¡: <strong>${lastInfo.avgShip}ì¼</strong><br>
       â€¢ ìœ í˜•: <strong>${lastInfo.productType}</strong>`});

  const n=parseInt(grade.g);
  const risk=grade.g==='í˜‘ì˜ í•„ìš”'?'ê³ ìœ„í—˜':n<=2?'ë‚®ì€ ë¦¬ìŠ¤í¬':n<=3?'ë³´í†µ ë¦¬ìŠ¤í¬':'ë†’ì€ ë¦¬ìŠ¤í¬';
  secs.push({t:'ğŸ“Š ì¢…í•©',
    b:`<strong>${risk}</strong> â€” ì´ ${total}ì , ê¸°ì¤€ ${base}ì  â†’ ${grade.g}${
      limit?`<br>ë‹´ë³´ <strong>${moneyFmt(coll)}</strong> ê¶Œì¥`:''}`});

  document.getElementById('revArea').innerHTML=secs.map(s=>
    `<div class="rev"><div class="rev-t">${s.t}</div><div class="rev-b">${s.b}</div></div>`
  ).join('');
}

function renderColl(cur){
  let ci=0; COLL_TBL.forEach((row,i)=>{ if(cur!==undefined&&cur>=row.min)ci=i; });
  document.getElementById('collTb').innerHTML=COLL_TBL.map((row,i)=>
    `<tr class="${i===ci&&cur!==undefined?'cur':''}">
      <td>${row.min===-9999?'ìµœì €ì  ì´í•˜':row.min+'ì  ì´ìƒ'}</td>
      <td>${(row.r*100).toFixed(0)}%</td>
    </tr>`).join('');
}

function popup(icon,msg){
  document.getElementById('popIc').textContent=icon;
  document.getElementById('popMsg').textContent=msg;
  document.getElementById('ov').classList.add('on');
  setTimeout(()=>document.getElementById('ov').classList.remove('on'),2500);
}

function resetAll(){
  sel={}; unv=[]; lastInfo=null; apiSt={};
  ['urlInp','bizInp'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('limitInp').value='100,000,000';
  document.getElementById('prog').classList.remove('on');
  document.getElementById('bizCard').classList.remove('on');
  document.getElementById('siteAnal').style.display='none';
  document.getElementById('alertBox').classList.remove('on');
  document.getElementById('logbox').innerHTML='';
  document.getElementById('totalScore').innerHTML='0<span style="font-size:18px">ì </span>';
  document.getElementById('rLimit').textContent='-';
  document.getElementById('rColl').textContent='-';
  document.getElementById('gBadge').textContent='-';
  document.getElementById('gMon').textContent='ë“±ê¸‰ ë¯¸ì‚°ì •';
  document.getElementById('baseScore').textContent='0';
  document.getElementById('monLv').textContent='-';
  document.getElementById('monFr').textContent='-';
  document.getElementById('revArea').innerHTML='';
  renderCats(); renderColl();
}

// UI ì´ˆê¸°í™”
document.getElementById('siteAnal').style.display='none';
document.getElementById('bizCard').classList.remove('on');
document.getElementById('alertBox').classList.remove('on');
init();

</script>
</body>
</html>
